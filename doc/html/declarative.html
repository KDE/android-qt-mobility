<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!-- declarative.qdoc -->
<head>
  <title>Qt Mobility Project 1.0: Service Framework using QML Example</title>
  <link href="classic.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top" width="32"><a href="http://qt.nokia.com/"><img src="images/qtlogo.png" align="left" border="0" /></a></td>
<td width="1">&nbsp;&nbsp;</td><td class="postheader" valign="center"><a href="index.html"><font color="#004faf">Home</font></a>&nbsp;&middot; <a href="classes.html"><font color="#004faf">All&nbsp;Classes</font></a>&nbsp;&middot; <a href="functions.html"><font color="#004faf">All&nbsp;Functions</font></a>&nbsp;&middot;</td>
<td align="right" valign="top" width="230"><img src="images/codeless.png"  border="0" /></td></tr></table><h1 class="title">Service Framework using QML Example<br /><span class="subtitle"></span>
</h1>
<p>Files:</p>
<ul>
<li><a href="declarative-sfwexample-cpp.html">declarative/sfwexample.cpp</a></li>
<li><a href="declarative-sfwexample-h.html">declarative/sfwexample.h</a></li>
<li><a href="declarative-landlinedialer-landlinedialer-cpp.html">declarative/landlinedialer/landlinedialer.cpp</a></li>
<li><a href="declarative-landlinedialer-landlinedialer-h.html">declarative/landlinedialer/landlinedialer.h</a></li>
<li><a href="declarative-landlinedialer-landlinedialerplugin-cpp.html">declarative/landlinedialer/landlinedialerplugin.cpp</a></li>
<li><a href="declarative-landlinedialer-landlinedialerplugin-h.html">declarative/landlinedialer/landlinedialerplugin.h</a></li>
<li><a href="declarative-voipdialer-voipdialer-cpp.html">declarative/voipdialer/voipdialer.cpp</a></li>
<li><a href="declarative-voipdialer-voipdialer-h.html">declarative/voipdialer/voipdialer.h</a></li>
<li><a href="declarative-voipdialer-voipdialerplugin-cpp.html">declarative/voipdialer/voipdialerplugin.cpp</a></li>
<li><a href="declarative-voipdialer-voipdialerplugin-h.html">declarative/voipdialer/voipdialerplugin.h</a></li>
<li><a href="declarative-main-cpp.html">declarative/main.cpp</a></li>
<li><a href="declarative-declarative-pro.html">declarative/declarative.pro</a></li>
<li><a href="declarative-demo-demo-pro.html">declarative/demo/demo.pro</a></li>
<li><a href="declarative-landlinedialer-landlinedialer-pro.html">declarative/landlinedialer/landlinedialer.pro</a></li>
<li><a href="declarative-voipdialer-voipdialer-pro.html">declarative/voipdialer/voipdialer.pro</a></li>
</ul>
<p><b>Explanation:</b></p>
<p>This example should demonstrate how to use the Service Framework and access the services in a QMLContext.</p>
<a name="guidesign"></a><p>The GUI looks like following picture:</p>
<p align="center"><img src="images/DialerServiceGUI.png" alt="&quot;GUI&quot;" /></p><p>The following picture shows the architecture of this example:</p>
<p align="center"><img src="images/DialerServiceUML.png" alt="&quot;UML&quot;" /></p><p>The following steps outline how to make a QML based application using the Service Framework technology. It is assumed that Qt Mobility has been successfully built and environment variables have been set as per <a href="installation.html">Installation Guide</a>.</p>
<p><b>The main function:</b></p>
<p>For the usage of several Qml objects and Service Framework we need to prepare our main.cpp:</p>
<ol type="1">
<li>Include the appropriate headers</li>
<li>Include the neccessary Qml objects header</li>
<li>Include the Service Framework object header</li>
</ol>
<p>Steps 1 and 2 are shown in the example below:</p>
<pre><span class="comment">    //Includes for using the QML objects</span>
    #include &lt;QmlView&gt;
    #include &lt;QmlContext&gt;

<span class="comment">    //Includes for using the service framework</span>
    #include &lt;qserviceinterfacedescriptor.h&gt;
    #include &lt;qservicemanager.h&gt;</pre>
<p>We are using the QmlView header which we need to load the main Qml file and show the Qml site.</p>
<pre>        QUrl url(qmlFile);
        QFileInfo fi(qmlFile);
        if (fi.exists())
            url = QUrl::fromLocalFile(fi.absoluteFilePath());
        else
            return 1;

        QmlView canvas;
        canvas.setSource(url);
        <span class="comment">//...</span>
        canvas.execute();
        canvas.show();</pre>
<p>Furthermore we are using the <a href="http://qt.nokia.com/doc/4.6/qmlcontext.html">QmlContext</a> header which we need to add our own implemented object in the Qml context. This means that we can create our own object and access it in a QML script file. <a name="addpropertyinqmlcontext"></a>In this case we can access our service list over the &quot;services&quot; property in Qml script.</p>
<pre></pre>
<p><b>The Services:</b></p>
<p>The services are implemented in a shared library and can be register in the service framework. After the service is registered it can be used in different applications. In our case we'll access the services over an application that is based on QML scripting. We will be able to change between different services and call their properties, receiving their signals and so forth.</p>
<p>In this example we've implemented 2 services called Landdialer and Voipdialer. You can find the projects for those services in:</p>
<p>declarative\landlinedialer and declarative\voipdialer. Those projects will create a shared library in each case.</p>
<p>If the library needs to be available over the Service Framework, we need to register the library. You can do this by using the <a href="qservicemanager.html">QServiceManager</a> function addService(..&#x2e;)&#x2e; In our example this will be done in the function registerExampleServices in ServiceRegister:</p>
<pre>        QStringList exampleXmlFiles;
        exampleXmlFiles &lt;&lt; &quot;voipdialerservice.xml&quot; &lt;&lt; &quot;landlinedialerservice.xml&quot;;
        foreach (const QString &amp;fileName, exampleXmlFiles) {
            QString path = QCoreApplication::applicationDirPath() + &quot;/xmldata/&quot; + fileName;
            serviceManager-&gt;addService(path);
        }</pre>
<p>As you can see we register the services using a xml file. This xml file basically contains all information to register the shared library in the Service Framework enviroment. For more information please read more about the Qt Service Framework <a href="service-frameworks.html#adding-and-removing-of-services">XML Format</a></p>
<p>The <a href="qservicemanager.html">QServiceManager</a> creates an instance of a services over a <a href="qserviceplugininterface.html">QServicePluginInterface</a>. For each services we provide a Plugin.</p>
<pre>    class VoipDialerPlugin : public QObject,
                                    public QServicePluginInterface
    {
        Q_OBJECT
        Q_INTERFACES(QtMobility::QServicePluginInterface)</pre>
<p>The Q_INTERFACES macro tells Qt which interfaces the class implements.</p>
<p>Both seviceplugins needs to implement the <a href="qserviceplugininterface.html">QServicePluginInterface</a>. In our case we only need to overwrite the virtual function createInstance.</p>
<pre>    QObject* VoipDialerPlugin::createInstance(const QServiceInterfaceDescriptor&amp; descriptor, QServiceContext* context, QAbstractSecuritySession* session)
    {
        Q_UNUSED(descriptor);
        Q_UNUSED(context);
        Q_UNUSED(session);
        return new VoipDialer(this);
    }

    Q_EXPORT_PLUGIN2(serviceframework_voipdialerservice, VoipDialerPlugin)</pre>
<p>As you can see the createInstance function create the appropriate dialer object and returns it. The Q_EXPORT_PLUGIN2 macro provides the neccessary implementation for a plugin. See <a href="http://qt.nokia.com/doc/4.6/plugins-howto.html">How to Create Qt Plugins</a> for more details.</p>
<p>The last thing we need to provide in our services are the states, properties, signals and slots that we want to access in out QML script later.</p>
<a name="voipdialer-h-0"></a><pre>    public:
        enum ConnectionState {
            Disconnected = 0,
            Connecting,
            Connected,
            Engaged
        };
        Q_PROPERTY( ConnectionState state READ state NOTIFY stateChanged);
        ConnectionState state() const;

    public slots:
        void dialNumber(const QString&amp; number);
        void hangup();

    signals:
        void stateChanged();</pre>
<p><b>The ServiceWrapper:</b></p>
<p>The ServiceWarpper is our object that is accessible in the QML script. Over the ServiceWrapper we can access several service details by calling the properties of the wrapper.</p>
<pre>    class ServiceWrapper : public QObject {
        Q_OBJECT
        Q_PROPERTY(bool isValid READ isValid);
        Q_PROPERTY(QString serviceName READ serviceName CONSTANT);
        Q_PROPERTY(QString interfaceName READ interfaceName CONSTANT);
        Q_PROPERTY(QString version READ version NOTIFY versionChanged);</pre>
<p><b>The ServiceRegister:</b></p>
<p>The ServiceRegister contains a list of all available services they contain the com.nokia.qt.examples.Dialer interface. In the constructor of ServiceRegister a call will be made to register the dialer services (LandLineDialer and VoipDaler) from this example.</p>
<pre>        QStringList exampleXmlFiles;
        exampleXmlFiles &lt;&lt; &quot;voipdialerservice.xml&quot; &lt;&lt; &quot;landlinedialerservice.xml&quot;;
        foreach (const QString &amp;fileName, exampleXmlFiles) {
            QString path = QCoreApplication::applicationDirPath() + &quot;/xmldata/&quot; + fileName;
            serviceManager-&gt;addService(path);
        }</pre>
<p>After this call the ServiceRegister fills it's internal ServiceWrappper <a href="http://qt.nokia.com/doc/4.6/qlist.html">QList</a>.</p>
<pre>        ServiceWrapper *service;
        QServiceFilter filter(&quot;com.nokia.qt.examples.Dialer&quot;);
        QList&lt;QServiceInterfaceDescriptor&gt; allImpl = serviceManager-&gt;findInterfaces(filter);
        for (int i = 0; i &lt; allImpl.count(); i++) {
            qDebug() &lt;&lt; &quot;Found service:&quot; &lt;&lt; allImpl.at(i).serviceName() &lt;&lt; &quot;(&quot; &lt;&lt; allImpl.at(i).interfaceName() &lt;&lt; &quot;)&quot;;
            service = new ServiceWrapper();
            service-&gt;setNativeDescriptor(allImpl.at(i));
            m_services.append(service);
        }</pre>
<p>In the header of ServiceRegister we allow external objects to access the ServiceWrapper <a href="http://qt.nokia.com/doc/4.6/qlist.html">QList</a>.</p>
<pre>    class ServiceRegister : public QObject {
        Q_OBJECT
        Q_PROPERTY(QList&lt;ServiceWrapper*&gt;* registeredservices READ registeredservices NOTIFY modelChanged CONSTANT);</pre>
<p>You may remember that we add this <a href="http://qt.nokia.com/doc/4.6/qlist.html">QList</a> to our qml context as a property named <a href="#addpropertyinqmlcontext"> services</a></p>
<p><b>Service access on the QML site</b></p>
<p>The QML elements are implemented in 4 different qml scripting files <a href="#guidesign"> see GUI design</a>.</p>
<p>In the ServiceList.qml file the services property is assigned to the ListView model property.</p>
<pre>            ListView {
                id: serviceListView
                height: 100
                width: 260
                anchors.topMargin: 5
                anchors.leftMargin: 5
                anchors.rightMargin: 5
                model: services.registeredservices</pre>
<p>To show the items of the model property we need to create a delegate component and assign it to the ListView Delegate property:</p>
<pre>            Component {
                id: delegate</pre>
<p>In this component you can define how you want to draw one ListView item. You can acces insite of this component the current ListWiew item by using the variable modelData. In our example we are using two text lines. Furthermore we can define whats happening if we click on a ListView item by using the MouseRegion.</p>
<a name="servicelist-qml-2"></a><pre>                    MouseRegion {
                        id: listItemMouseRegion
                        anchors.fill: parent
                        onClicked: {
                            if(listFrame.nohighlightlistitem){
                                serviceListView.highlight = highlight
                                listFrame.nohighlightlistitem = false;
                            }
                            serviceListView.currentIndex = index;
                            dialService = model.modelData;
                            console.log(&quot;HELLO: &quot; + dialService + &quot; &quot; + model.modelData);
                            serviceSelected()
                        }
                    }

                    Text {
                        id: serviceItemInfo
                        anchors.top: parent.top
                        anchors.left: parent.left
                        anchors.topMargin: 5
                        anchors.leftMargin: 3
                        text: &quot; &lt;b&gt;Service:&lt;/b&gt; &quot; + serviceName + &quot;  (&quot; + version + &quot;)&quot;
                    }

                    Text {
                        id: serviceItemInterfaceName
                        anchors.top: serviceItemInfo.bottom
                        anchors.left: parent.left
                        anchors.topMargin: 2
                        anchors.leftMargin: 3
                        text: &quot; &lt;b&gt;Interface:&lt;/b&gt; &quot; + interfaceName;
                    }</pre>
<p>Another component can be created for highliting a list item:</p>
<pre>            Component {
                id: highlight

                Rectangle {
                    width: childrenRect.width
                    border.color: &quot;black&quot;; border.width: 2
                    height: 30
                    color : &quot;lightsteelblue&quot;
                    gradient: Gradient {
                        GradientStop {position: 0.0; color: &quot;steelblue&quot;}
                        GradientStop {position: 0.5; color: &quot;lightsteelblue&quot;}
                        GradientStop {position: 1.0; color: &quot;steelblue&quot;}
                    }
                }
            }</pre>
<p><b>Service signals and function calls on the QML site</b></p>
<p>In sfw-kinetic-example.qml we define a control named DialScreen and implement the function onDial and onHangup. As you can see in the onDial event we call the service function dialNumber and the onHangup calls hangup. Both function are implemented in the service <a href="#voipdialer-h-0"> (see voipdialer header file).</a></p>
<pre>        DialScreen {
            id: dialScreen
            property bool activeCall : false
            property var currentDialer: 0;
            anchors.topMargin: 5
            anchors.leftMargin: 5
            anchors.rightMargin: 5
            anchors.right: parent.right
            anchors.top: parent.top
            onDial: {
                if (activeCall == false) {
                    if (serviceList.dialService != 0) {
                        var o = serviceList.dialService.serviceObject();
                        status.text = &quot;Dialing &quot; + numberToDial +&quot;...&quot;;
                        dialScreen.currentDialer = o;
                        o.dialNumber(numberToDial);
                        activeCall = true;
                    }
                }
            }
            onHangup: {
                if (activeCall) {
                    if (dialScreen.currentDialer != 0) {
                        dialScreen.currentDialer.hangup();
                    }
                    status.text = &quot;Hang up&quot;;
                }
            }
        }</pre>
<p>In DialScreen.qml the dial and the hangup signals are defined. The hangup signal will be emited if the HangUpButton was clicked:</p>
<pre>        DialButton {
            id: hangUpButton
            height: { (numberPad.height / 2) - 2 }
            width: 50
            anchors.top: numberPad.top
            anchors.left: numberPad.right
            anchors.leftMargin: 5
            hoverColor: &quot;red&quot;
            color: &quot;crimson&quot;
            onClicked: {
                dialString = &quot;&quot;
                hangup()
            }</pre>
<p>The dial signal will be emited if the CallButton was clicked:</p>
<pre>        DialButton {
            id: callButton
            width: 50
            height: {(numberPad.height/2) -2}
            anchors.top: hangUpButton.bottom
            anchors.left: numberPad.right
            anchors.leftMargin: 5
            anchors.topMargin: 4
            color: &quot;mediumseagreen&quot;
            hoverColor: &quot;lightgreen&quot;
            onClicked: {
                if (dialString != &quot;&quot;) {
                    dial(dialString)
                    dialString = &quot;&quot;
                }
            }</pre>
<p>Now we need to connect the stateChanged signal form the services with an event handler on the QML site. This is done in the sfw-kinetic-example.qml file:</p>
<pre>        Connection {
            sender: dialScreen
            signal: &quot;stateChanged()&quot;
            script: {
                if (dialScreen.currentDialer.state == 1) {
                    status.text += &quot;\nRinging&quot;;
                }
                else if (dialScreen.currentDialer.state == 2) {
                    status.text += &quot;\nConnected&quot;;
                }
                else if (dialScreen.currentDialer.state == 0) {
                    status.text += &quot;\nConnection terminated&quot;;
                    dialScreen.activeCall = false;
                    clearStatusTimer.running = true;
                }
                else if (dialScreen.currentDialer.state == 3) {
                    status.text += &quot;\nPhone already engaged&quot;;
                }
            }
        }</pre>
<p>The DialScreen.currentDialer is assigned during a ListView item click in the <a href="#servicelist-qml-2"> ServiceList.qml file</a>.</p>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td align="left">Copyright &copy; 2009 Nokia Corporation and/or its subsidiary(-ies)</td>
<td width="20%" align="center"><a href="trademarks.html">Trademarks</a></td>
<td align="right"><div align="right">Qt Mobility Project 1.0.0</div></td>
</tr></table></div></address></body>
</html>
