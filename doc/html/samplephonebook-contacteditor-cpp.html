<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Qt Mobility Project 1.0: contacteditor.cpp Example File (samplephonebook/contacteditor.cpp)</title>
  <link href="classic.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top" width="32"><a href="http://qt.nokia.com/"><img src="images/qtlogo.png" align="left" border="0" /></a></td>
<td width="1">&nbsp;&nbsp;</td><td class="postheader" valign="center"><a href="index.html"><font color="#004faf">Home</font></a>&nbsp;&middot; <a href="classes.html"><font color="#004faf">All&nbsp;Classes</font></a>&nbsp;&middot; <a href="functions.html"><font color="#004faf">All&nbsp;Functions</font></a>&nbsp;&middot;</td>
<td align="right" valign="top" width="230"><img src="images/codeless.png"  border="0" /></td></tr></table><h1 class="title">contacteditor.cpp Example File<br /><span class="small-subtitle">samplephonebook/contacteditor.cpp</span>
</h1>
<pre><span class="comment">    /****************************************************************************
    **
    ** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
    ** All rights reserved.
    ** Contact: Nokia Corporation (qt-info@nokia.com)
    **
    ** This file is part of the Qt Mobility Components.
    **
    ** $QT_BEGIN_LICENSE:LGPL$
    ** No Commercial Usage
    ** This file contains pre-release code and may not be distributed.
    ** You may use this file in accordance with the terms and conditions
    ** contained in the Technology Preview License Agreement accompanying
    ** this package.
    **
    ** GNU Lesser General Public License Usage
    ** Alternatively, this file may be used under the terms of the GNU Lesser
    ** General Public License version 2.1 as published by the Free Software
    ** Foundation and appearing in the file LICENSE.LGPL included in the
    ** packaging of this file.  Please review the following information to
    ** ensure the GNU Lesser General Public License version 2.1 requirements
    ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
    **
    ** In addition, as a special exception, Nokia gives you certain additional
    ** rights.  These rights are described in the Nokia Qt LGPL Exception
    ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package.
    **
    ** If you have questions regarding the use of this file, please contact
    ** Nokia at qt-info@nokia.com.
    **
    **
    **
    **
    **
    **
    **
    **
    ** $QT_END_LICENSE$
    **
    ****************************************************************************/</span>

    #include &quot;contacteditor.h&quot;

    #include &lt;QtGui&gt;

    ContactEditor::ContactEditor(QWidget *parent)
            : QWidget(parent)
    {
        m_manager = 0;
        m_contactId = QContactLocalId(0);

        m_saveBtn = new QPushButton(&quot;Save&quot;, this);
        connect(m_saveBtn, SIGNAL(clicked()), this, SLOT(saveClicked()));
        m_deleteBtn = new QPushButton(&quot;Delete&quot;, this);
        connect(m_deleteBtn, SIGNAL(clicked()), this, SLOT(deleteClicked()));
        m_cancelBtn = new QPushButton(&quot;Cancel&quot;, this);
        connect(m_cancelBtn, SIGNAL(clicked()), this, SLOT(cancelClicked()));

        m_nameEdit = new QLineEdit(this);
        m_phoneEdit = new QLineEdit(this);
        m_emailEdit = new QLineEdit(this);
        m_addrEdit = new QLineEdit(this);
        m_avatarBtn = new QPushButton(this);
        m_avatarBtn-&gt;setSizePolicy(QSizePolicy::Expanding, QSizePolicy::Expanding);
        connect(m_avatarBtn, SIGNAL(clicked()), this, SLOT(avatarClicked()));

        m_detailsArea = new QScrollArea(this);
        m_detailsArea-&gt;setWidgetResizable(true);
        QFormLayout *detailsLayout = new QFormLayout;
        detailsLayout-&gt;addRow(&quot;Name&quot;, m_nameEdit);
        detailsLayout-&gt;addRow(&quot;Phone&quot;, m_phoneEdit);
        detailsLayout-&gt;addRow(&quot;Email&quot;, m_emailEdit);
        detailsLayout-&gt;addRow(&quot;Address&quot;, m_addrEdit);
        detailsLayout-&gt;addRow(&quot;Avatar&quot;, m_avatarBtn);
        detailsLayout-&gt;setFieldGrowthPolicy(QFormLayout::ExpandingFieldsGrow);
        detailsLayout-&gt;setSizeConstraint(QLayout::SetMinAndMaxSize);
        m_detailsArea-&gt;setLayout(detailsLayout);

        QHBoxLayout *btnLayout = new QHBoxLayout;
        btnLayout-&gt;addWidget(m_saveBtn);
        btnLayout-&gt;addWidget(m_deleteBtn);
        btnLayout-&gt;addWidget(m_cancelBtn);

        QVBoxLayout *editLayout = new QVBoxLayout;
        editLayout-&gt;addWidget(m_detailsArea);
        editLayout-&gt;addLayout(btnLayout);

        setLayout(editLayout);
    }

    ContactEditor::~ContactEditor()
    {
    }

    void ContactEditor::setCurrentContact(QContactManager* manager, QContactLocalId currentId)
    {
        m_manager = manager;
        m_contactId = currentId;
        m_newAvatarPath = QString();

        if (manager == 0 || currentId == 0) {
            <span class="comment">// clear the UI and return.</span>
            m_nameEdit-&gt;setText(&quot;&quot;);
            m_phoneEdit-&gt;setText(&quot;&quot;);
            m_emailEdit-&gt;setText(&quot;&quot;);
            m_addrEdit-&gt;setText(&quot;&quot;);
            m_avatarBtn-&gt;setIcon(QIcon());

            if (manager == 0)
                m_saveBtn-&gt;setEnabled(false);
            m_deleteBtn-&gt;setEnabled(false);

            return;
        }

        <span class="comment">// enable the UI.</span>
        m_saveBtn-&gt;setEnabled(true);
        m_deleteBtn-&gt;setEnabled(true);

        <span class="comment">// otherwise, build from the contact details.</span>
        QContact curr = manager-&gt;contact(m_contactId);
        QContactName nm = curr.detail(QContactName::DefinitionName);
        QContactPhoneNumber phn = curr.detail(QContactPhoneNumber::DefinitionName);
        QContactEmailAddress em = curr.detail(QContactEmailAddress::DefinitionName);
        QContactAddress adr = curr.detail(QContactAddress::DefinitionName);
        QContactAvatar av = curr.detail(QContactAvatar::DefinitionName);

        QString saveNameField = nameField();
        if (!saveNameField.isEmpty())
            m_nameEdit-&gt;setText(nm.value(saveNameField));
        else
            m_nameEdit-&gt;setText(QString());
        m_phoneEdit-&gt;setText(phn.value(QContactPhoneNumber::FieldNumber));
        m_emailEdit-&gt;setText(em.value(QContactEmailAddress::FieldEmailAddress));
        m_addrEdit-&gt;setText(adr.value(QContactAddress::FieldStreet)); <span class="comment">// ugly hack.</span>
        m_avatarBtn-&gt;setIcon(QIcon(av.value(QContactAvatar::FieldAvatar)));
    }

    QString ContactEditor::nameField()
    {
        <span class="comment">// return the field which the name data should be saved in.</span>
        if (!m_manager)
            return QString();

        QMap&lt;QString, QContactDetailDefinition&gt; defs = m_manager-&gt;detailDefinitions(QContactType::TypeContact);
        QContactDetailDefinition nameDef = defs.value(QContactName::DefinitionName);
        if (nameDef.fields().keys().contains(QContactName::FieldCustomLabel)) {
            return QString(QLatin1String(QContactName::FieldCustomLabel));
        } else if (nameDef.fields().keys().contains(QContactName::FieldFirst)) {
            return QString(QLatin1String(QContactName::FieldFirst));
        } else {
            return QString();
        }
    }

    void ContactEditor::avatarClicked()
    {
        <span class="comment">// put up a file dialog, and update the new avatar path.</span>
        QString fileName = QFileDialog::getOpenFileName(this,
           tr(&quot;Select Avatar Image&quot;), &quot;.&quot;, tr(&quot;Image Files (*.png *.jpg *.bmp)&quot;));

        m_newAvatarPath = fileName;
        m_avatarBtn-&gt;setIcon(QIcon(m_newAvatarPath));
    }

    void ContactEditor::saveClicked()
    {
        if (!m_manager) {
            qWarning() &lt;&lt; &quot;No manager selected; cannot save.&quot;;
        } else {
            QContact curr;
            if (m_contactId != QContactLocalId(0))
                curr = m_manager-&gt;contact(m_contactId);
            QContactName nm = curr.detail(QContactName::DefinitionName);
            QContactPhoneNumber phn = curr.detail(QContactPhoneNumber::DefinitionName);
            QContactEmailAddress em = curr.detail(QContactEmailAddress::DefinitionName);
            QContactAddress adr = curr.detail(QContactAddress::DefinitionName);
            QContactAvatar av = curr.detail(QContactAvatar::DefinitionName);

            QString saveNameField = nameField();
            if (!saveNameField.isEmpty())
                nm.setValue(nameField(), m_nameEdit-&gt;text());
            phn.setNumber(m_phoneEdit-&gt;text());
            em.setEmailAddress(m_emailEdit-&gt;text());
            adr.setStreet(m_addrEdit-&gt;text());
            av.setAvatar(m_newAvatarPath);

            curr.saveDetail(&amp;nm);
            curr.saveDetail(&amp;phn);
            curr.saveDetail(&amp;em);
            curr.saveDetail(&amp;adr);
            curr.saveDetail(&amp;av);

            bool success = m_manager-&gt;saveContact(&amp;curr);
            if (success)
                QMessageBox::information(this, &quot;Success!&quot;, &quot;Contact saved successfully!&quot;);
            else
                QMessageBox::information(this, &quot;Failed!&quot;, &quot;Failed to save contact!&quot;);
        }

        emit showListPage();
    }

    void ContactEditor::deleteClicked()
    {
        if (!m_manager) {
            qWarning() &lt;&lt; &quot;No manager selected; cannot delete.&quot;;
        } else {
            if (m_contactId == QContactLocalId(0))
                qWarning() &lt;&lt; &quot;Contact is invalid; cannot delete.&quot;;

            bool success = m_manager-&gt;removeContact(m_contactId);
            if (success)
                QMessageBox::information(this, &quot;Success!&quot;, &quot;Contact deleted successfully!&quot;);
            else
                QMessageBox::information(this, &quot;Failed!&quot;, &quot;Failed to delete contact!&quot;);
        }

        emit showListPage();
    }

    void ContactEditor::cancelClicked()
    {
        emit showListPage();
    }</pre>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td align="left">Copyright &copy; 2009 Nokia Corporation and/or its subsidiary(-ies)</td>
<td width="20%" align="center"><a href="trademarks.html">Trademarks</a></td>
<td align="right"><div align="right">Qt Mobility Project 1.0.0</div></td>
</tr></table></div></address></body>
</html>
