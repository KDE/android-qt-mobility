<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- writemessage.qdoc -->
  <title>Qt 1.1: 'Write Message' Example</title>
  <link rel="stylesheet" type="text/css" href="style/style.css"
 />  <!--[if IE]>
<meta name="MSSmartTagsPreventParsing" content="true">
<meta http-equiv="imagetoolbar" content="no">
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="style/style_ie6.css">
<![endif]-->
<!--[if IE 7]>
<link rel="stylesheet" type="text/css" href="style/style_ie7.css">
<![endif]-->
<!--[if IE 8]>
<link rel="stylesheet" type="text/css" href="style/style_ie8.css">
<![endif]-->
  <script src="scripts/jquery.js" type="text/javascript"></script>
  <script src="scripts/functions.js" type="text/javascript"></script>
 <script src="./scripts/superfish.js" type="text/javascript"></script>
 <script src="./scripts/narrow.js" type="text/javascript"></script>
  <link rel="stylesheet" type="text/css" href="style/superfish.css" />  <link rel="stylesheet" type="text/css" href="style/narrow.css" /></head>
<body class="" onload="CheckEmptyAndLoadList();">
 <div class="header" id="qtdocheader">
    <div id="nav-logo">
      <a href="index.html">Home</a></div>
    <a href="index.html" class="qtref"><span>Qt Mobility Reference Documentation</span></a>
    <div id="nav-topright">
      <ul>
        <li class="nav-topright-home"><a href="http://qt.nokia.com/">Qt HOME</a></li>
        <li class="nav-topright-dev"><a href="http://qt.nokia.com/developer">DEV</a></li>
        <li class="nav-topright-labs"><a href="http://labs.qt.nokia.com/blogs/">LABS</a></li>
        <li class="nav-topright-doc nav-topright-doc-active"><a href="http://doc.qt.nokia.com/">
          DOC</a></li>
        <li class="nav-topright-blog"><a href="http://blog.qt.nokia.com/">BLOG</a></li>
        <li class="nav-topright-shop"><a title="SHOP" href="http://shop.qt.nokia.com">SHOP</a></li>
      </ul>
    </div>
    <div id="shortCut">
      <ul>
        <li class="shortCut-topleft-inactive"><span><a href="index.html">Mobility 1.1</a></span></li>
        <li class="shortCut-topleft-active"><a href="http://qt.nokia.com/doc/">ALL Qt VERSIONS        </a></li>
      </ul>
    </div>
  </div>
  <div class="wrapper">
    <div class="hd">
      <span></span>
    </div>
    <div class="bd group">
      <div class="sidebar">
        <div class="searchlabel">
          Search index:</div>
        <div class="search">
          <form id="qtdocsearch" action="">
            <fieldset>
              <input type="text" name="searchstring" id="pageType" value="" />
            </fieldset>
          </form>
        </div>
        <div class="box first bottombar" id="lookup">
          <h2><span></span>
            API Lookup</h2>
          <div  id="list001" class="list">
          <ul id="ul001" >
              <li class="defaultLink"><a href="classes.html">Class index</a></li>
              <li class="defaultLink"><a href="functions.html">Function index</a></li>
              <li class="defaultLink"><a href="modules.html">Modules</a></li>
              <li class="defaultLink"><a href="namespaces.html">Namespaces</a></li>
              <li class="defaultLink"><a href="qtglobal.html">Global stuff</a></li>
              <li class="defaultLink"><a href="qdeclarativeelements.html">QML elements</a></li>
            </ul> 
          </div>
        </div>
        <div class="box bottombar" id="topics">
          <h2><span></span>
            Qt Topics</h2>
          <div id="list002" class="list">
            <ul id="ul002" >
              <li class="defaultLink"><a href="qt-basic-concepts.html">Basic Qt architecture</a></li>
              <li class="defaultLink"><a href="declarativeui.html">Device UI's &amp; Qt Quick</a></li>
              <li class="defaultLink"><a href="qt-gui-concepts.html">Desktop UI components</a></li>
              <li class="defaultLink"><a href="platform-specific.html">Platform-specific info</a></li>
            </ul>  
          </div>
        </div>
        <div class="box" id="examples">
          <h2><span></span>
            Examples</h2>
          <div id="list003" class="list">
        <ul id="ul003">
              <li class="defaultLink"><a href="all-examples.html">Examples</a></li>
              <li class="defaultLink"><a href="tutorials.html">Tutorials</a></li>
              <li class="defaultLink"><a href="demos.html">Demos</a></li>
              <li class="defaultLink"><a href="qdeclarativeexamples.html">QML Examples</a></li>
              <li class="defaultLink"><a href="qdeclarativeexamples.html#Demos">QML Demos</a></li>
            </ul> 
          </div>
        </div>
      </div>
      <div class="wrap">
        <div class="toolbar">
          <div class="breadcrumb toolblock">
            <ul>
              <li class="first"><a href="index.html">Home</a></li>
              <!--  Bread crumbs goes here -->
              <li><a href="all-examples.html">Examples</a></li>              <li><a href="examples-writemessage.html"></a></li>              <li>'Write Message' Example</li>            </ul>
          </div>
          <div class="toolbuttons toolblock">
            <ul>
              <li id="smallA" class="t_button">A</li>
              <li id="medA" class="t_button active">A</li>
              <li id="bigA" class="t_button">A</li>
              <li id="print" class="t_button"><a href="javascript:this.print();">
                <span>Print</span></a></li>
            </ul>
          </div>
        </div>
        <div class="content">
<h1 class="title">'Write Message' Example</h1>
<span class="subtitle"></span>
<div class="descr"/>
<p>Files:</p>
<ul>
<li><a href="writemessage-messagesender-cpp.html">writemessage/messagesender.cpp</a></li>
<li><a href="writemessage-messagesender-h.html">writemessage/messagesender.h</a></li>
<li><a href="writemessage-main-cpp.html">writemessage/main.cpp</a></li>
<li><a href="writemessage-writemessage-pro.html">writemessage/writemessage.pro</a></li>
</ul>
<p>This example demonstrates using the Qt Mobility Messaging API to create and send a simple message.</p>
<p class="centerAlign"><img src="images/writemessage-example.png" /></p><p>The writemessage application provides an interface allowing the user to compose a simple message and send that message to one or more recipients. The type of message that is sent will depend on the messaging account that the user selects for transmission.</p>
<p>In order to know what type of message to create, our application requires that the user select an account to transmit with. We create a listing to present the user a choice, by populating a combo box with the names of the available accounts:</p>
<pre class="highlightedCode brush: cpp">     <span class="comment">// Find the list of available accounts and add them to combo box</span>
     foreach (const QMessageAccountId &amp;id, manager.queryAccounts()) {
         QMessageAccount account(id);

         <span class="comment">// What is the most capable message type supported by this account?</span>
         QMessage::Type type(QMessage::NoType);
         if (account.messageTypes() &amp; QMessage::Email) {
             type = QMessage::Email;
         } else if (account.messageTypes() &amp; QMessage::Mms) {
             type = QMessage::Mms;
         } else if (account.messageTypes() &amp; QMessage::Sms) {
             type = QMessage::Sms;
         }

         if (type != QMessage::NoType) {
             QString name(account.name());
             accountDetails.insert(name, qMakePair(type, account.id()));
             accountCombo-&gt;addItem(name);
         }
     }</pre>
<p>We create a mapping of the account name to the most capable type of message that can be transmitted via that account. When an account is selected, we will adjust our UI to disable the message elements that cannot be transmitted using the associated message type. For example, an SMS message cannot transmit attachments or a subject line.</p>
<pre class="highlightedCode brush: cpp"> void MessageSender::accountSelected(int index)
 {
     QString name(accountCombo-&gt;itemText(index));
     if (!name.isEmpty()) {
         QPair&lt;QMessage::Type, QMessageAccountId&gt; details = accountDetails[name];

         <span class="comment">// Enable subject only for email</span>
         subjectEdit-&gt;setEnabled(details.first == QMessage::Email);

         <span class="comment">// Disable attachments for SMS</span>
         const bool smsOnly(details.first == QMessage::Sms);
         addButton-&gt;setEnabled(!smsOnly);
         removeButton-&gt;setEnabled(!smsOnly);
     }
 }</pre>
<p>When the user presses the Send button, we create a message that contains the information they have provided. First of all, we create a message object to transmit, and associate it with the account and message type that correspond to the user's account selection:</p>
<pre class="highlightedCode brush: cpp">     QString accountName(accountCombo-&gt;currentText());
     if (accountName.isEmpty()) {
         QMessageBox::warning(0, tr(&quot;Missing information&quot;), tr(&quot;No account is selected for transmission&quot;));
         return;
     }

     QMessage message;

     QPair&lt;QMessage::Type, QMessageAccountId&gt; details = accountDetails[accountName];
     message.setType(details.first);
     message.setParentAccountId(details.second);</pre>
<p>Next, we process the recipient address or addresses that were provided. For each whitespace-separated element, we create an address object that has that element as the recipient, with the address type determined by the type of message we are constructing.</p>
<pre class="highlightedCode brush: cpp">     QString to(toEdit-&gt;text());
     if (to.isEmpty()) {
         QMessageBox::warning(0, tr(&quot;Missing information&quot;), tr(&quot;Please enter a recipient address&quot;));
         return;
     }

     <span class="comment">// Find the address type to use for this message</span>
     QMessageAddress::Type addrType(message.type() == QMessage::Email ? QMessageAddress::Email : QMessageAddress::Phone);

     QMessageAddressList toList;
     foreach (const QString &amp;item, to.split(QRegExp(&quot;\\s&quot;), QString::SkipEmptyParts)) {
         toList.append(QMessageAddress(addrType, item));
     }
     message.setTo(toList);</pre>
<p>Next, we set the subject of the message (if the message can contain a subject) and set the text of the message.</p>
<pre class="highlightedCode brush: cpp">     if (message.type() == QMessage::Email) {
         QString subject(subjectEdit-&gt;text());
         if (subject.isEmpty()) {
             QMessageBox::warning(0, tr(&quot;Missing information&quot;), tr(&quot;Please enter a subject&quot;));
             return;
         }
         message.setSubject(subject);
     }

     QString text(textEdit-&gt;toPlainText());
     if (text.isEmpty()) {
         QMessageBox::warning(0, tr(&quot;Missing information&quot;), tr(&quot;Please enter a message&quot;));
         return;
     }
     message.setBody(text);</pre>
<p>If the message can contain attachments, we add them as a list of file paths to be appended to the message:</p>
<pre class="highlightedCode brush: cpp">     if (message.type() != QMessage::Sms) {
         if (attachmentsList-&gt;count()) {
             QStringList paths;
             for (int i = 0; i &lt; attachmentsList-&gt;count(); ++i) {
                 paths.append(attachmentsList-&gt;item(i)-&gt;text());
             }

             message.appendAttachments(paths);
         }
     }</pre>
<p>Now that we have created our message, we use the <a href="qmessageservice.html#send">QMessageService::send</a>() operation to request that the message be stored in the system and transmitted:</p>
<pre class="highlightedCode brush: cpp">     sendButton-&gt;setEnabled(false);
     if (service.send(message)) {
         sendId = message.id();
     } else {
         sendButton-&gt;setEnabled(true);
         QMessageBox::warning(0, tr(&quot;Failed&quot;), tr(&quot;Unable to send message&quot;));
     }</pre>
<p>To determine whether our transmission is successful, we wait for changes to the <a href="qmessageservice.html#state">state</a> of the <a href="qmessageservice.html">QMessageService</a> object. When the state changes to the FinishedState, we need to check whether the request was successful or not:</p>
<pre class="highlightedCode brush: cpp"> void MessageSender::stateChanged(QMessageService::State newState)
 {
     if (newState == QMessageService::FinishedState) {
         if (service.error() == QMessageManager::NoError) {
             QMessageBox::information(0, tr(&quot;Success&quot;), tr(&quot;Message sent successfully&quot;));
         } else {
             QMessageBox::warning(0, tr(&quot;Failed&quot;), tr(&quot;Unable to send message&quot;));

             <span class="comment">// Try to delete the failed message</span>
             if (!manager.removeMessage(sendId)) {
                 qWarning() &lt;&lt; &quot;Unable to remove failed message:&quot; &lt;&lt; sendId.toString();
             }
         }

         sendId = QMessageId();
         sendButton-&gt;setEnabled(true);
     }
 }</pre>
</div>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td align="left">Copyright &copy; 2009-2010 Nokia Corporation and/or its subsidiary(-ies)</td>
<td width="20%" align="center"><a href="trademarks.html">Trademarks</a></td>
<td align="right"><div align="right">Qt Mobility Project 1.1.0</div></td>
</tr></table></div></address>  <script src="scripts/functions.js" type="text/javascript"></script>
</body>
</html>
