<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Qt Mobility Project 1.0: testmodelui.cpp Example File (incomingcalls/testmodelui.cpp)</title>
  <link href="classic.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top" width="32"><a href="http://qt.nokia.com/"><img src="images/qtlogo.png" align="left" border="0" /></a></td>
<td width="1">&nbsp;&nbsp;</td><td class="postheader" valign="center"><a href="index.html"><font color="#004faf">Home</font></a>&nbsp;&middot; <a href="classes.html"><font color="#004faf">All&nbsp;Classes</font></a>&nbsp;&middot; <a href="functions.html"><font color="#004faf">All&nbsp;Functions</font></a>&nbsp;&middot;</td>
<td align="right" valign="top" width="230"><img src="images/codeless.png"  border="0" /></td></tr></table><h1 class="title">testmodelui.cpp Example File<br /><span class="small-subtitle">incomingcalls/testmodelui.cpp</span>
</h1>
<pre><span class="comment">    /****************************************************************************
    **
    ** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
    ** All rights reserved.
    ** Contact: Nokia Corporation (qt-info@nokia.com)
    **
    ** This file is part of the Qt Mobility Components.
    **
    ** $QT_BEGIN_LICENSE:LGPL$
    ** No Commercial Usage
    ** This file contains pre-release code and may not be distributed.
    ** You may use this file in accordance with the terms and conditions
    ** contained in the Technology Preview License Agreement accompanying
    ** this package.
    **
    ** GNU Lesser General Public License Usage
    ** Alternatively, this file may be used under the terms of the GNU Lesser
    ** General Public License version 2.1 as published by the Free Software
    ** Foundation and appearing in the file LICENSE.LGPL included in the
    ** packaging of this file.  Please review the following information to
    ** ensure the GNU Lesser General Public License version 2.1 requirements
    ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
    **
    ** In addition, as a special exception, Nokia gives you certain additional
    ** rights.  These rights are described in the Nokia Qt LGPL Exception
    ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package.
    **
    ** If you have questions regarding the use of this file, please contact
    ** Nokia at qt-info@nokia.com.
    **
    **
    **
    **
    **
    **
    **
    **
    ** $QT_END_LICENSE$
    **
    ****************************************************************************/</span>

    #include &quot;testmodelui.h&quot;
    #include &quot;qtcontacts.h&quot;
    #include &quot;qcontactlistmodel.h&quot;
    #include &quot;qcontactfetchrequest.h&quot;

    #include &lt;QtGui&gt;

    TestModelView::TestModelView(QContactManager* manager)
            : QListView()
    {
        model = new QContactListModel(manager);
        setModel(model);
    }

    TestModelView::~TestModelView()
    {
        delete model;
    }

    QContactLocalId TestModelView::currentId() const
    {
        return QContactLocalId(model-&gt;data(currentIndex(), QContactListModel::IdRole).toUInt());
    }

    QVariant TestModelView::currentData(QContactListModel::ContactDataRole role) const
    {
        return model-&gt;data(currentIndex(), role);
    }

    TestModelUi::TestModelUi()
            : QWidget()
    {
        manager = new QContactManager(&quot;memory&quot;);
        populateContacts();
        nbrMissedCalls = 0;
        talkingToNumber = &quot;&quot;;

        dialog = new FilterDialog;
        connect(dialog, SIGNAL(hidden()), this, SLOT(filterFound()));

        fetchRequest = new QContactFetchRequest;
        fetchRequest-&gt;setManager(manager);
        connect(fetchRequest, SIGNAL(progress(QContactFetchRequest*,bool)), this, SLOT(dataAvailable(QContactFetchRequest*,bool)));
        filterRequest = new QContactFetchRequest;
        filterRequest-&gt;setManager(manager);
        connect(filterRequest, SIGNAL(progress(QContactFetchRequest*,bool)), this, SLOT(filterResults(QContactFetchRequest*,bool)));

        incomingCallTimer = new QTimer;
        incomingCallTimer-&gt;setInterval(15000); <span class="comment">// 15 seconds between incoming calls.</span>
        dialTimer = new QTimer;
        dialTimer-&gt;setInterval(3000); <span class="comment">// they answer after 3 seconds</span>
        answerTimer = new QTimer;
        answerTimer-&gt;setInterval(6000); <span class="comment">// missed call after 6 seconds</span>

        connect(incomingCallTimer, SIGNAL(timeout()), this, SLOT(incoming()));
        connect(dialTimer, SIGNAL(timeout()), this, SLOT(talking()));
        connect(answerTimer, SIGNAL(timeout()), this, SLOT(missedCall()));
        incomingCallTimer-&gt;start();

        list = new TestModelView(manager);
        textEdit = new QTextEdit;
        viewArea = new QStackedWidget;
        viewArea-&gt;addWidget(list);
        viewArea-&gt;addWidget(textEdit);
        viewArea-&gt;setCurrentIndex(0);

        missedCalls = new QLabel;
        missedCalls-&gt;setAlignment(Qt::AlignLeft);
        missedCalls-&gt;setText(QString(tr(&quot;# Missed Calls:&quot;)));
        missedCallsNbr = new QLabel;
        missedCallsNbr-&gt;setAlignment(Qt::AlignRight);
        missedCallsNbr-&gt;setText(QString::number(nbrMissedCalls));

        leftButton = new QPushButton(tr(&quot;Dial&quot;));
        middleButton = new QPushButton(tr(&quot;Find&quot;));
        rightButton = new QPushButton(tr(&quot;Quit&quot;));

        connect(leftButton, SIGNAL(clicked()), this, SLOT(dial()));
        connect(middleButton, SIGNAL(clicked()), this, SLOT(findContact()));
        connect(rightButton, SIGNAL(clicked()), this, SLOT(close()));

        QHBoxLayout *missedLayout = new QHBoxLayout;
        missedLayout-&gt;addWidget(missedCalls);
        missedLayout-&gt;addWidget(missedCallsNbr);

        QHBoxLayout *btnLayout = new QHBoxLayout;
        btnLayout-&gt;addWidget(leftButton);
        btnLayout-&gt;addWidget(middleButton);
        btnLayout-&gt;addWidget(rightButton);

        QVBoxLayout *listLayout = new QVBoxLayout;
        listLayout-&gt;addLayout(missedLayout);
        listLayout-&gt;addWidget(viewArea);
        listLayout-&gt;addLayout(btnLayout);

        setLayout(listLayout);
    }

    TestModelUi::~TestModelUi()
    {
        delete fetchRequest;
        delete filterRequest;

        delete leftButton;
        delete rightButton;
        delete list;
        delete textEdit;
        delete viewArea;
        delete dialog;
        delete manager;
    }

    void TestModelUi::populateContacts()
    {
        <span class="comment">// generate some fictional contacts.</span>
        QStringList nameFirst;
        nameFirst &lt;&lt; &quot;Adam&quot; &lt;&lt; &quot;Adrianna&quot; &lt;&lt; &quot;Alex&quot; &lt;&lt; &quot;Brett&quot; &lt;&lt; &quot;Bob&quot;
                  &lt;&lt; &quot;Carina&quot; &lt;&lt; &quot;Christina&quot; &lt;&lt; &quot;Carl&quot; &lt;&lt; &quot;Daniel&quot; &lt;&lt; &quot;Denise&quot;
                  &lt;&lt; &quot;Eric&quot; &lt;&lt; &quot;Fred&quot; &lt;&lt; &quot;Mario&quot; &lt;&lt; &quot;William&quot; &lt;&lt; &quot;Zandi&quot;;
        QStringList nameLast;
        nameLast &lt;&lt; &quot;Citizen&quot; &lt;&lt; &quot;Civilian&quot; &lt;&lt; &quot;Doe&quot; &lt;&lt; &quot;Generic&quot; &lt;&lt; &quot;Public&quot; &lt;&lt; &quot;Unlikely&quot;;

        QStringList phoneFirst;
        phoneFirst &lt;&lt; &quot;111&quot; &lt;&lt; &quot;222&quot; &lt;&lt; &quot;333&quot; &lt;&lt; &quot;444&quot; &lt;&lt; &quot;555&quot; &lt;&lt; &quot;666&quot; &lt;&lt; &quot;777&quot; &lt;&lt; &quot;888&quot;
                   &lt;&lt; &quot;123&quot; &lt;&lt; &quot;234&quot; &lt;&lt; &quot;345&quot; &lt;&lt; &quot;456&quot; &lt;&lt; &quot;567&quot; &lt;&lt; &quot;678&quot; &lt;&lt; &quot;789&quot;;
        QStringList phoneLast;
        phoneLast &lt;&lt; &quot;9876&quot; &lt;&lt; &quot;8765&quot; &lt;&lt; &quot;7654&quot; &lt;&lt; &quot;6543&quot; &lt;&lt; &quot;5432&quot; &lt;&lt; &quot;4321&quot;;

        QStringList emailFirst;
        emailFirst &lt;&lt; &quot;testPersonOne&quot; &lt;&lt; &quot;testPersonTwo&quot; &lt;&lt; &quot;testPersonThree&quot; &lt;&lt; &quot;testPersonFour&quot; &lt;&lt; &quot;testPersonFive&quot;
                   &lt;&lt; &quot;testPersonSix&quot; &lt;&lt; &quot;testPersonSeven&quot; &lt;&lt; &quot;testPersonEight&quot; &lt;&lt; &quot;testPersonNine&quot; &lt;&lt; &quot;testPersonTen&quot;
                   &lt;&lt; &quot;testPersonEleven&quot; &lt;&lt; &quot;testPersonTwelve&quot; &lt;&lt; &quot;testPersonThirteen&quot; &lt;&lt; &quot;testPersonFourteen&quot; &lt;&lt; &quot;testPersonFifteen&quot;;
        QStringList emailLast;
        emailLast &lt;&lt; &quot;@test1.nokia.com&quot; &lt;&lt; &quot;@test2.nokia.com&quot; &lt;&lt; &quot;@test3.nokia.com&quot;
                  &lt;&lt; &quot;@test4.nokia.com&quot; &lt;&lt; &quot;@test5.nokia.com&quot; &lt;&lt; &quot;@test6.nokia.com&quot;;

        QStringList avatarFirst;
        avatarFirst &lt;&lt; &quot;party&quot; &lt;&lt; &quot;celebration&quot; &lt;&lt; &quot;happyface&quot; &lt;&lt; &quot;grinning&quot; &lt;&lt; &quot;smile&quot;
                    &lt;&lt; &quot;laughing&quot; &lt;&lt; &quot;dance&quot; &lt;&lt; &quot;serious&quot; &lt;&lt; &quot;angry&quot; &lt;&lt; &quot;sadface&quot;
                    &lt;&lt; &quot;tree&quot; &lt;&lt; &quot;mountain&quot; &lt;&lt; &quot;ocean&quot; &lt;&lt; &quot;city&quot; &lt;&lt; &quot;bridge&quot;;
        QStringList avatarLast;
        avatarLast &lt;&lt; &quot;.png&quot; &lt;&lt; &quot;.bmp&quot; &lt;&lt; &quot;.jpg&quot; &lt;&lt; &quot;.gif&quot; &lt;&lt; &quot;.avi&quot; &lt;&lt; &quot;.mpg&quot;;

        for (int i = 0; i &lt; 15; i++) {
            for (int j = 0; j &lt; 6; j++) {
                QContact c;
                QContactName n;
                QContactPhoneNumber p;
                QContactEmailAddress e;
                QContactAvatar a;

                n.setFirst(nameFirst.at(i));
                n.setLast(nameLast.at(j));
                p.setNumber(phoneFirst.at(i) + phoneLast.at(j));
                e.setEmailAddress(emailFirst.at(i) + emailLast.at(j));
                a.setAvatar(avatarFirst.at(i) + avatarLast.at(j));

                c.saveDetail(&amp;n);
                c.saveDetail(&amp;p);
                c.saveDetail(&amp;e);
                c.saveDetail(&amp;a);

                manager-&gt;saveContact(&amp;c);
            }
        }
    }

    void TestModelUi::dataAvailable(QContactFetchRequest* request, bool appendOnly)
    {
        Q_UNUSED(appendOnly);

        <span class="comment">// first, make sure we can use the data.</span>
        if (currentState == TestModelUi::WaitingState || request-&gt;status() != QContactAbstractRequest::Finished)
            return;

        <span class="comment">// we assume that we need the extra details.</span>
        QString text;

        QList&lt;QContact&gt; requestData = request-&gt;contacts();
        if (requestData.isEmpty() || requestData.at(0).isEmpty()) {
            text += &quot;Unknown Contact&quot;;
            talkingToDetails = text;
            textEdit-&gt;setText(talkingToFirstLine + &quot; &quot; + talkingToNumber + &quot;\n\n&quot; + talkingToDetails);
            return;
        }

        QContact curr = request-&gt;contacts().at(0);
        QList&lt;QContactDetail&gt; allDetails = curr.details();
        foreach (const QContactDetail&amp; det, allDetails) {
            QString defName = det.definitionName();
            text += defName + &quot;:&quot; + &quot;\n&quot;;
            QList&lt;QString&gt; fieldKeys = det.values().keys();
            foreach (const QString&amp; key, fieldKeys) {
                text += &quot;\t&quot; + key + &quot; = &quot; + det.value(key) + &quot;\n&quot;;
            }
            text += &quot;\n&quot;;
        }

        talkingToName = curr.displayLabel();
        if (currentState == TestModelUi::DialingState) {
            talkingToNumber = curr.detail(QContactPhoneNumber::DefinitionName).value(QContactPhoneNumber::FieldNumber);
        }

        if (!text.isEmpty())
            text.chop(1); <span class="comment">// kill unneeded newline.</span>
        talkingToDetails = text;
        textEdit-&gt;setText(talkingToFirstLine + &quot; &quot; + talkingToName + &quot;\n\n&quot; + talkingToDetails);
    }

    void TestModelUi::filterResults(QContactFetchRequest* request, bool appendOnly)
    {
        Q_UNUSED(appendOnly);
        QList&lt;QContact&gt; results = request-&gt;contacts();
        QString text = &quot;Matching Contacts:\n&quot;;
        for (int i = 0; i &lt; results.size(); i++) {
            text += &quot;\n&quot; + results.at(i).displayLabel();
        }
        textEdit-&gt;setText(text);

        if (request-&gt;status() == QContactAbstractRequest::Finished) {
            if (results.isEmpty())
                textEdit-&gt;setText(&quot;Matching Contacts:\n\nNo Matches Found!&quot;);
            rightButton-&gt;setText(tr(&quot;Done&quot;));
            middleButton-&gt;setEnabled(true);
        }
    }

    void TestModelUi::filterFound()
    {
        QContactFilter fil = dialog-&gt;filter();
        if (dialog-&gt;status() &gt; 0) {
            textEdit-&gt;setText(&quot;Finding Contacts...\n\n&quot;);
            filterRequest-&gt;cancel();
            filterRequest-&gt;setFilter(fil);
            filterRequest-&gt;start();
        } else {
            finishedFindContact();
        }
    }

    void TestModelUi::showFilterDialog()
    {
        middleButton-&gt;setEnabled(false);
        textEdit-&gt;setText(&quot;Selecting search criteria...&quot;);
        rightButton-&gt;setText(tr(&quot;Cancel&quot;));
        dialog-&gt;showDialog();
    }

    void TestModelUi::findContact()
    {
        <span class="comment">// complex filtering.</span>
        incomingCallTimer-&gt;stop();
        dialTimer-&gt;stop();
        answerTimer-&gt;stop();

        textEdit-&gt;setText(&quot;Please select a search criteria (click search)&quot;);
        middleButton-&gt;disconnect();
        rightButton-&gt;disconnect();
        leftButton-&gt;setEnabled(false);
        middleButton-&gt;setEnabled(true);
        rightButton-&gt;setEnabled(true);
        middleButton-&gt;setText(tr(&quot;Search&quot;));
        rightButton-&gt;setText(tr(&quot;Cancel&quot;));
        connect(middleButton, SIGNAL(clicked()), this, SLOT(showFilterDialog()));
        connect(rightButton, SIGNAL(clicked()), this, SLOT(finishedFindContact()));
        viewArea-&gt;setCurrentIndex(1);
    }

    void TestModelUi::finishedFindContact()
    {
        <span class="comment">// only allow them to finish if they close the find contact dialog.</span>
        if (dialog-&gt;status() == 0)
            return;

        hangup();
    }

    void TestModelUi::dial()
    {
        <span class="comment">// get current index id from view</span>
        <span class="comment">// change current widget to text</span>
        <span class="comment">// change buttons to &lt;gray&gt; &lt;hangup&gt;</span>
        <span class="comment">// ...</span>
        incomingCallTimer-&gt;stop();
        answerTimer-&gt;stop();
        currentState = TestModelUi::DialingState;

        QContactLocalIdFilter fil;
        QList&lt;QContactLocalId&gt; fetchIds;
        fetchIds &lt;&lt; list-&gt;currentId();
        fil.setIds(fetchIds);
        fetchRequest-&gt;cancel(); <span class="comment">// if not already stopped.</span>
        fetchRequest-&gt;setFilter(fil);
        fetchRequest-&gt;start();

        talkingToFirstLine = &quot;Dialing&quot;;
        talkingToName = list-&gt;currentData(QContactListModel::DisplayLabelRole).toString();
        textEdit-&gt;setText(talkingToFirstLine + &quot; &quot; + talkingToName + &quot;\n\n&quot; + talkingToDetails);
        leftButton-&gt;disconnect();
        rightButton-&gt;disconnect();
        leftButton-&gt;setText(tr(&quot;Dial&quot;));
        rightButton-&gt;setText(tr(&quot;Cancel&quot;));
        connect(rightButton, SIGNAL(clicked()), this, SLOT(hangup()));
        leftButton-&gt;setEnabled(false);
        middleButton-&gt;setEnabled(false);
        viewArea-&gt;setCurrentIndex(1);
        dialTimer-&gt;start();
    }

    void TestModelUi::incoming()
    {
        <span class="comment">// change current widget to text</span>
        <span class="comment">// change buttons to &lt;answer&gt; &lt;hangup&gt;</span>
        <span class="comment">// ...</span>
        incomingCallTimer-&gt;stop();
        dialTimer-&gt;stop();
        currentState = TestModelUi::IncomingState;

        <span class="comment">// create some phone numbers.  about half appear in our contacts, half do not.</span>
        QStringList phoneFirst;
        phoneFirst &lt;&lt; &quot;111&quot; &lt;&lt; &quot;222&quot; &lt;&lt; &quot;337&quot; &lt;&lt; &quot;944&quot; &lt;&lt; &quot;555&quot; &lt;&lt; &quot;611&quot; &lt;&lt; &quot;777&quot; &lt;&lt; &quot;855&quot;
                   &lt;&lt; &quot;123&quot; &lt;&lt; &quot;234&quot; &lt;&lt; &quot;385&quot; &lt;&lt; &quot;456&quot; &lt;&lt; &quot;587&quot; &lt;&lt; &quot;688&quot; &lt;&lt; &quot;788&quot;;
        QStringList phoneLast;
        phoneLast &lt;&lt; &quot;9876&quot; &lt;&lt; &quot;8765&quot; &lt;&lt; &quot;7654&quot; &lt;&lt; &quot;9543&quot; &lt;&lt; &quot;5432&quot; &lt;&lt; &quot;9321&quot;;

        int firstIndex = qrand() % phoneFirst.size();
        int lastIndex = qrand() % phoneLast.size();
        talkingToNumber = phoneFirst.at(firstIndex) + phoneLast.at(lastIndex);
        talkingToFirstLine = &quot;Incoming call from&quot;;
        textEdit-&gt;setText(talkingToFirstLine + &quot; &quot; + talkingToNumber + &quot;\n\n&quot; + talkingToDetails);

        QContactDetailFilter fil;
        fil.setDetailDefinitionName(QContactPhoneNumber::DefinitionName, QContactPhoneNumber::FieldNumber);
        fil.setValue(talkingToNumber);
        fetchRequest-&gt;cancel(); <span class="comment">// if not already stopped.</span>
        fetchRequest-&gt;setFilter(fil);
        fetchRequest-&gt;start();

        leftButton-&gt;disconnect();
        rightButton-&gt;disconnect();
        leftButton-&gt;setText(tr(&quot;Answer&quot;));
        rightButton-&gt;setText(tr(&quot;Hang Up&quot;));
        connect(leftButton, SIGNAL(clicked()), this, SLOT(talking()));
        connect(rightButton, SIGNAL(clicked()), this, SLOT(hangup()));
        leftButton-&gt;setEnabled(true);
        middleButton-&gt;setEnabled(false);
        viewArea-&gt;setCurrentIndex(1);

        answerTimer-&gt;start();
    }

    void TestModelUi::talking()
    {
        <span class="comment">// get id of contact from incoming?</span>
        <span class="comment">// using async contact request with filter?</span>
        <span class="comment">// change current widget to text</span>
        <span class="comment">// change buttons to &lt;gray&gt; &lt;hangup&gt;</span>
        <span class="comment">// ...</span>
        incomingCallTimer-&gt;stop();
        dialTimer-&gt;stop();
        answerTimer-&gt;stop();
        currentState = TestModelUi::TalkingState;

        talkingToFirstLine = &quot;Talking to&quot;;
        textEdit-&gt;setText(talkingToFirstLine + &quot; &quot; + (talkingToName.isEmpty() ? talkingToNumber : talkingToName) + &quot;\n\n&quot; + talkingToDetails);
        leftButton-&gt;disconnect();
        rightButton-&gt;disconnect();
        leftButton-&gt;setText(tr(&quot;Answer&quot;));
        rightButton-&gt;setText(tr(&quot;Hang Up&quot;));
        connect(rightButton, SIGNAL(clicked()), this, SLOT(hangup()));
        leftButton-&gt;setEnabled(false);
        middleButton-&gt;setEnabled(false);
    }

    void TestModelUi::hangup()
    {
        <span class="comment">// change current widget to list</span>
        <span class="comment">// change buttons to &lt;dial&gt; &lt;exit&gt;</span>
        <span class="comment">// ...</span>
        incomingCallTimer-&gt;stop();
        dialTimer-&gt;stop();
        answerTimer-&gt;stop();
        currentState = TestModelUi::WaitingState;

        talkingToName = &quot;&quot;;
        talkingToNumber = &quot;&quot;;
        talkingToDetails = &quot;&quot;;
        talkingToFirstLine = &quot;&quot;;
        textEdit-&gt;setText(&quot;&quot;);
        leftButton-&gt;disconnect();
        middleButton-&gt;disconnect();
        rightButton-&gt;disconnect();
        leftButton-&gt;setText(tr(&quot;Dial&quot;));
        middleButton-&gt;setText(tr(&quot;Find&quot;));
        rightButton-&gt;setText(tr(&quot;Quit&quot;));
        connect(leftButton, SIGNAL(clicked()), this, SLOT(dial()));
        connect(middleButton, SIGNAL(clicked()), this, SLOT(findContact()));
        connect(rightButton, SIGNAL(clicked()), this, SLOT(close()));
        leftButton-&gt;setEnabled(true);
        middleButton-&gt;setEnabled(true);
        viewArea-&gt;setCurrentIndex(0);
        incomingCallTimer-&gt;start(); <span class="comment">// restart the incoming call timer.</span>
    }

    void TestModelUi::missedCall()
    {
        <span class="comment">// increment missed call count</span>
        <span class="comment">// change current widget to list</span>
        <span class="comment">// change buttons to &lt;dial&gt; &lt;exit&gt;</span>
        <span class="comment">// ...</span>
        nbrMissedCalls += 1;
        missedCallsNbr-&gt;setText(QString::number(nbrMissedCalls));
        hangup();
    }</pre>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td align="left">Copyright &copy; 2009 Nokia Corporation and/or its subsidiary(-ies)</td>
<td width="20%" align="center"><a href="trademarks.html">Trademarks</a></td>
<td align="right"><div align="right">Qt Mobility Project 1.0 (BETA)</div></td>
</tr></table></div></address></body>
</html>
