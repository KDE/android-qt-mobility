#!/bin/sh
# the name of this script
relconf=`basename $0`
# the directory of this script is the "source tree"
relpath=`dirname $0`
relpath=`(cd "$relpath"; /bin/pwd)`
QT_MOBILITY_PREFIX=$relpath/install
QT_MOBILITY_INCLUDE=
QT_MOBILITY_LIB=
QT_MOBILITY_BIN=
BUILD_UNITTESTS=
BUILD_EXAMPLES=
RELEASEMODE=
CONTACTS_PLUGIN=

usage() 
{
    echo "Usage: configure [-prefix <dir>] [headerdir <dir>] [libdir <dir>]"
    echo "                 [-bindir <dir>] [-tests] [-examples] [debug]"
    echo "                 [-release]"
    echo
    echo "Options:"
    echo
    echo "-prefix <dir> ..... This will install everything relative to <dir>"
    echo "                    (default prefix: $relpath/install)"
    echo "-headerdir <dir> .. Header files will be installed to <dir>"
    echo "                    (default prefix: PREFIX/include)"
    echo "-libdir <dir> ..... Libraries will be installed to <dir>"
    echo "                    (default PREFIX/lib)"
    echo "-bindir <dir> ..... Executables will be installed to <dir>"
    echo "                    (default PREFIX/bin)"
    echo "-debug ............ Build with debugging symbols"
    echo "-release .......... Build without debugging symbols"
    echo "-tests ............ Build unit tests (not build by default)"
    echo "-examples ......... Build example applications"
    echo
    echo "-contact-src <backend> ..."
    echo "                    Compile the specified contacts API backend. Not selecting any backend"
    echo "                    will result in default selection for build platform"
    echo "                    options: symbian, wince, kabc, memory"
    
    rm config.in
    exit    
}

echo "CONFIG += silent"  > config.in

while [ "$#" -gt 0 ]; do
    case "$1" in 
        -h|-help|--help)
            usage
            ;;
        -headerdir)
            QT_MOBILITY_INCLUDE="$2"
            shift
            ;;
        -libdir)
            QT_MOBILITY_LIB="$2"
            shift
            ;;
        --prefix|-prefix)
            QT_MOBILITY_PREFIX="$2"
            shift
            ;;
        -bindir)
            QT_MOBILITY_BIN="$2"
            shift
            ;;
        -tests)
            BUILD_UNITTESTS="yes"
            ;;
        -examples)
            BUILD_EXAMPLES="yes"
            ;;
        -debug)
            RELEASEMODE=debug
            ;;
        -release)
            RELEASEMODE=release
            ;;
        -contact-src)
            CONTACTS_PLUGIN="$CONTACTS_PLUGIN $2"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            usage
            ;;
    esac
    shift
done

if [ -z "$RELEASEMODE" ]; then
    RELEASEMODE="debug"
fi
echo "CONFIG += $RELEASEMODE" >> config.in
echo "CONTACTS_BACKENDS = $CONTACTS_PLUGIN" >> config.in

#process PREFIX
if [ -d "$QT_MOBILITY_PREFIX" ]; then
    QT_MOBILITY_PREFIX=`(cd "$QT_MOBILITY_PREFIX"; /bin/pwd)`
else
    mkdir -p "$QT_MOBILITY_PREFIX"
    absPath=`(cd "$QT_MOBILITY_PREFIX"; /bin/pwd)`
    rm -rf "$QT_MOBILITY_PREFIX"
    QT_MOBILITY_PREFIX="$absPath"
fi
echo "QT_MOBILITY_PREFIX = $QT_MOBILITY_PREFIX" >> config.in

#process include path
if [ -z "$QT_MOBILITY_INCLUDE" ]; then
    QT_MOBILITY_INCLUDE="$QT_MOBILITY_PREFIX/include"
elif [ -d "$QT_MOBILITY_INCLUDE" ]; then
    QT_MOBILITY_INCLUDE=`(cd "$QT_MOBILITY_INCLUDE"; /bin/pwd)`
else
    mkdir -p "$QT_MOBILITY_INCLUDE"
    absPath=`(cd "$QT_MOBILITY_INCLUDE"; /bin/pwd)`
    rm -rf "$QT_MOBILITY_INCLUDE"
    QT_MOBILITY_INCLUDE="$absPath"
fi
echo "QT_MOBILITY_INCLUDE = $QT_MOBILITY_INCLUDE" >> config.in


#process library path
if [ -z "$QT_MOBILITY_LIB" ]; then
    QT_MOBILITY_LIB="$QT_MOBILITY_PREFIX/lib"
elif [ -d "$QT_MOBILITY_LIB" ]; then
    QT_MOBILITY_LIB=`(cd "$QT_MOBILITY_LIB"; /bin/pwd)`
else
    mkdir -p "$QT_MOBILITY_LIB"
    absPath=`(cd "$QT_MOBILITY_LIB"; /bin/pwd)`
    rm -rf "$QT_MOBILITY_LIB"
    QT_MOBILITY_LIB="$absPath"
fi
echo "QT_MOBILITY_LIB = $QT_MOBILITY_LIB" >> config.in

#process binary path
if [ -z "$QT_MOBILITY_BIN" ]; then
    QT_MOBILITY_BIN="$QT_MOBILITY_PREFIX/bin"
elif [ -d "$QT_MOBILITY_BIN" ]; then
    QT_MOBILITY_BIN=`(cd "$QT_MOBILITY_BIN"; /bin/pwd)`
else
    mkdir -p "$QT_MOBILITY_BIN"
    absPath=`(cd "$QT_MOBILITY_BIN"; /bin/pwd)`
    rm -rf "$QT_MOBILITY_BIN"
    QT_MOBILITY_BIN="$absPath"
fi
echo "QT_MOBILITY_BIN = $QT_MOBILITY_BIN" >> config.in

if [ -z "$BUILD_UNITTESTS" ]; then
    echo "build_unit_tests = no" >> config.in
else
    echo "build_unit_tests = yes" >> config.in
fi

if [ -z "$BUILD_EXAMPLES" ]; then
    echo "build_examples = no" >> config.in
else
    echo "build_examples = yes" >> config.in
fi

#search for QMF. Enabled if QMF_LIBDIR and QMF_INCLUDEPATH are set enable messging on windows
#TODO: convert into proper compile test
if [ -z "$QMF_LIBDIR" ]; then
    echo "qmf_enabled = no" >> config.in
elif [ -z "$QMF_INCLUDEDIR" ]; then
    echo "qmf_enabled = no" >> config.in
else
    echo "qmf_enabled = yes" >> config.in
fi

echo "Testing Qt installation..."
if ! which qmake; then
    echo >&2 "Cannot find 'qmake' in your PATH";
    echo >&2 "Aborting." 
fi

echo "Generating Mobility Headers..."
#remove old headers
rm -rf $relpath/include
mkdir $relpath/include
$relpath/bin/syncheaders $relpath/include $relpath/bearer
$relpath/bin/syncheaders $relpath/include $relpath/context
$relpath/bin/syncheaders $relpath/include $relpath/location
$relpath/bin/syncheaders $relpath/include $relpath/serviceframework
$relpath/bin/syncheaders $relpath/include $relpath/systeminfo
$relpath/bin/syncheaders $relpath/include $relpath/contacts
$relpath/bin/syncheaders $relpath/include $relpath/multimedia
$relpath/bin/syncheaders $relpath/include $relpath/messaging

mv config.in config.pri

echo "Running qmake..."
if qmake -recursive; then
    echo ""
    echo "configure has finished. You may run make or gmake to build the project now."
else
    echo ""
    echo "configure failed."
fi
